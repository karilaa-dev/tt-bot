---
last_mapped: 2026-01-19T12:00:00Z
total_files: 61
total_tokens: 71895
---

# Codebase Map

> Auto-generated by Cartographer. Last mapped: 2026-01-19

## System Overview

**tt-bot** is a production-grade Telegram bot for downloading TikTok videos, slideshows, and audio without watermarks. Built with Python 3.13, aiogram 3.x, and yt-dlp.

**Version:** 4.5.0
**Stack:** Python 3.13, aiogram 3.24, yt-dlp, curl_cffi, SQLAlchemy 2.0, asyncpg, aiohttp

```mermaid
graph TB
    subgraph Entry["Entry Points"]
        Main[main.py<br/>Main Bot]
        Stats[stats.py<br/>Stats Bot]
        Maint[maintenance_bot.py<br/>Maintenance Mode]
    end

    subgraph Handlers["Telegram Handlers"]
        Video[get_video.py<br/>Video Downloads]
        Music[get_music.py<br/>Audio Extraction]
        Inline[get_inline.py<br/>Inline Mode]
        User[user.py<br/>User Commands]
        Admin[admin.py<br/>Admin Commands]
        Lang[lang.py<br/>Language Selection]
        Advert[advert.py<br/>Broadcasts]
    end

    subgraph TikTok["TikTok API"]
        Client[client.py<br/>Main Client + 3-Part Retry]
        Proxy[proxy_manager.py<br/>Proxy Rotation]
        Models[models.py<br/>VideoInfo/MusicInfo]
        Exc[exceptions.py<br/>Error Types]
    end

    subgraph Data["Data Layer"]
        Config[config.py<br/>Configuration]
        DB[database.py<br/>SQLAlchemy Engine]
        DBSvc[db_service.py<br/>Repository]
        DBModels[models/<br/>User/Video/Music]
    end

    subgraph Misc["Utilities"]
        Queue[queue_manager.py<br/>Concurrency Control]
        VTypes[video_types.py<br/>Send/Process Media]
        Utils[utils.py<br/>Helpers]
    end

    subgraph StatsM["Stats Module"]
        Router[router.py<br/>Stats Commands]
        Graphs[graphs.py<br/>Graph Generation]
        StMisc[misc.py<br/>Stats Calculation]
    end

    Main --> Handlers
    Stats --> StatsM
    Handlers --> TikTok
    Handlers --> Misc
    TikTok --> Proxy
    Handlers --> Data
    StatsM --> Data
    VTypes --> Client
```

## 3-Part Retry Strategy

The TikTok extraction uses a 3-part retry strategy with proxy rotation:

```mermaid
graph TB
    subgraph PS["ProxySession"]
        Init[Initialize proxy]
        Rotate[Rotate on retry]
    end

    subgraph P1["Part 1: URL Resolution"]
        Resolve[_resolve_url]
        Short[Short URLs ‚Üí Full URLs]
    end

    subgraph P2["Part 2: Video Info"]
        Extract[_extract_video_info_with_retry]
        YtDlp[yt-dlp extraction]
    end

    subgraph P3["Part 3: Download"]
        Video[_download_video_with_retry]
        Slideshow[download_slideshow_images]
        Music[_download_music_with_retry]
    end

    PS --> P1
    P1 --> P2
    P2 --> P3

    P1 -.->|On failure| Rotate
    P2 -.->|On failure| Rotate
    P3 -.->|On failure| Rotate
```

**Key Design:**
- Same proxy used across all parts unless retry triggered
- Instant retry with proxy rotation (no delay)
- Individual image retry for slideshows (not whole batch)
- Permanent errors (deleted, private) not retried

## Chrome 120 Impersonation (Anti-WAF)

TikTok WAF blocks datacenter IPs and detects bot fingerprints. The solution:

```python
TIKTOK_IMPERSONATE_TARGET = "chrome120"  # Fixed to Chrome 120
TIKTOK_USER_AGENT = "Mozilla/5.0 ... Chrome/120.0.0.0 ..."  # Must match
```

**Implementation:**
- yt-dlp: `ImpersonateTarget("chrome", "120", "macos", None)`
- curl_cffi: `impersonate="chrome120"`
- Headers: User-Agent must match impersonation target

**Why Chrome 120?** Newer versions (136+) blocked when used with proxies due to fingerprint mismatches.

## Directory Structure

```
tt-bot/
‚îú‚îÄ‚îÄ main.py                 # Main bot entry point
‚îú‚îÄ‚îÄ stats.py                # Stats bot entry point
‚îú‚îÄ‚îÄ maintenance_bot.py      # Maintenance mode bot
‚îú‚îÄ‚îÄ tiktok_api/             # TikTok extraction module
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py         # Public exports
‚îÇ   ‚îú‚îÄ‚îÄ client.py           # Main TikTokClient + ProxySession + 3-part retry (1960 lines)
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py       # Exception hierarchy (9 error types)
‚îÇ   ‚îú‚îÄ‚îÄ models.py           # VideoInfo, MusicInfo dataclasses
‚îÇ   ‚îî‚îÄ‚îÄ proxy_manager.py    # Round-robin proxy rotation
‚îú‚îÄ‚îÄ handlers/               # Telegram message handlers
‚îÇ   ‚îú‚îÄ‚îÄ get_video.py        # Video/slideshow download handler + unsupported content handlers
‚îÇ   ‚îú‚îÄ‚îÄ get_music.py        # Audio extraction handler
‚îÇ   ‚îú‚îÄ‚îÄ get_inline.py       # Inline mode handler
‚îÇ   ‚îú‚îÄ‚îÄ user.py             # /start, /mode commands
‚îÇ   ‚îú‚îÄ‚îÄ admin.py            # Admin commands
‚îÇ   ‚îú‚îÄ‚îÄ advert.py           # Broadcast system
‚îÇ   ‚îî‚îÄ‚îÄ lang.py             # Language selection
‚îú‚îÄ‚îÄ data/                   # Data layer
‚îÇ   ‚îú‚îÄ‚îÄ config.py           # Configuration + RetryConfig
‚îÇ   ‚îú‚îÄ‚îÄ loader.py           # Bot/dispatcher initialization
‚îÇ   ‚îú‚îÄ‚îÄ database.py         # SQLAlchemy engine/session
‚îÇ   ‚îú‚îÄ‚îÄ db_service.py       # Database operations
‚îÇ   ‚îú‚îÄ‚îÄ db_utils.py         # URL utilities
‚îÇ   ‚îú‚îÄ‚îÄ locale/             # Language translations (8 languages)
‚îÇ   ‚îî‚îÄ‚îÄ models/             # SQLAlchemy models
‚îÇ       ‚îú‚îÄ‚îÄ users.py        # Users table
‚îÇ       ‚îú‚îÄ‚îÄ video.py        # Videos table
‚îÇ       ‚îî‚îÄ‚îÄ music.py        # Music table
‚îú‚îÄ‚îÄ misc/                   # Utilities
‚îÇ   ‚îú‚îÄ‚îÄ queue_manager.py    # Per-user concurrency control
‚îÇ   ‚îú‚îÄ‚îÄ video_types.py      # Media sending/processing + slideshow retry
‚îÇ   ‚îî‚îÄ‚îÄ utils.py            # Helper functions
‚îú‚îÄ‚îÄ stats/                  # Statistics module
‚îÇ   ‚îú‚îÄ‚îÄ loader.py           # Stats bot initialization
‚îÇ   ‚îú‚îÄ‚îÄ router.py           # Stats commands
‚îÇ   ‚îú‚îÄ‚îÄ graphs.py           # Matplotlib graphs
‚îÇ   ‚îú‚îÄ‚îÄ misc.py             # Stats calculation
‚îÇ   ‚îî‚îÄ‚îÄ botstat.py          # BotSafe integration
‚îú‚îÄ‚îÄ docs/                   # Documentation
‚îú‚îÄ‚îÄ scripts/                # Shell scripts
‚îú‚îÄ‚îÄ Dockerfile              # Container build
‚îú‚îÄ‚îÄ docker-compose.yml      # Service orchestration
‚îî‚îÄ‚îÄ pyproject.toml          # Dependencies (uv)
```

## Module Guide

### TikTok API (`tiktok_api/`)

**Purpose:** TikTok video/audio extraction using yt-dlp with browser impersonation and 3-part retry strategy

| File | Purpose | Tokens |
|------|---------|--------|
| client.py | Main TikTokClient + ProxySession + 3-part retry | 16,110 |
| proxy_manager.py | Thread-safe round-robin proxy rotation | 1,303 |
| models.py | VideoInfo, MusicInfo dataclasses | 1,079 |
| exceptions.py | Exception hierarchy (9 error types) | 233 |

**Resource Pooling (Class-Level Shared Resources):**
```python
_executor: ThreadPoolExecutor (500 workers)      # For yt-dlp sync calls
_aiohttp_connector: TCPConnector                  # For URL resolution (no limit)
_curl_session_pool: dict[proxy, CurlAsyncSession] # Per-proxy curl sessions (1000 clients each)
```

**Key Classes:**
- `TikTokClient`: Main extraction client with integrated retry
- `ProxySession`: Manages proxy state per request flow (sticky until retry)
- `ProxyManager`: Proxy rotation manager (singleton)
- `VideoInfo`, `MusicInfo`: Response dataclasses with context manager support

**Key Methods (3-Part Retry):**
- `_resolve_url()`: Part 1 - Resolve short URLs with retry
- `_extract_video_info_with_retry()`: Part 2 - Extract metadata with retry
- `_download_video_with_retry()`: Part 3 - Download video with retry
- `_download_music_with_retry()`: Part 3 - Download music with retry
- `download_slideshow_images()`: Part 3 - Download images with individual retry
- `video()`: Orchestrates all 3 parts (retries built-in)
- `music()`: Orchestrates Parts 2 & 3 (retries built-in)

**Exceptions:**
- `TikTokError`: Base class
- `TikTokInvalidLinkError`: Part 1 failure (URL resolution)
- `TikTokDeletedError`, `TikTokPrivateError`: Permanent errors (not retried)
- `TikTokNetworkError`, `TikTokExtractionError`: Transient errors (retried)
- `TikTokRateLimitError`, `TikTokRegionError`, `TikTokVideoTooLongError`

**Patterns:**
- Singleton resources (ThreadPoolExecutor, curl session, aiohttp connector)
- Context manager for VideoInfo cleanup (RAII)
- ProxySession for sticky proxy with rotation on retry

---

### Handlers (`handlers/`)

**Purpose:** Telegram message/callback handlers using aiogram routers

| File | Purpose | Tokens |
|------|---------|--------|
| get_video.py | Video/slideshow download + unsupported content handlers | 2,675 |
| get_inline.py | Inline query handling with minimal loading indicator | 1,334 |
| get_music.py | Audio extraction | 972 |
| advert.py | Admin broadcast system | 852 |
| lang.py | Language selection | 469 |
| user.py | /start, /mode commands | 384 |
| admin.py | Admin commands (/msg, /export, /botstat) | 348 |

**Key Routes:**
- `video_router`: Handles TikTok URLs in messages
- `music_router`: Handles music button callbacks
- `inline_router`: Handles inline queries and chosen results
- `user_router`: /start, /mode
- `lang_router`: /lang and language callbacks
- `admin_router`: Admin-only commands
- `advert_router`: Broadcast management

**Unsupported Content Handlers (NEW):**
- `handle_video_upload()`: Inform users to send links, not videos (F.video | F.video_note)
- `handle_image_upload()`: Inform users about TikTok links only (F.photo)
- `handle_voice_upload()`: Same for voice/audio (F.voice | F.audio)
- `handle_unsupported_content()`: Catch-all for unsupported content types

**Note:** Handlers call `video()` and `music()` directly - retry logic is built-in.

---

### Data Layer (`data/`)

**Purpose:** Configuration, database, and localization

| File | Purpose | Tokens |
|------|---------|--------|
| config.py | Load config + RetryConfig from env vars | 1,581 |
| db_service.py | Repository pattern database operations | 1,609 |
| database.py | SQLAlchemy async engine/session | 517 |
| loader.py | Bot/dispatcher/scheduler initialization | 293 |
| db_utils.py | Database URL utilities | 379 |

**Models:**
- `Users`: user_id, lang, file_mode, ad tracking
- `Video`: download history with timestamps
- `Music`: music download history

**Configuration Sections:**
- `bot`: Tokens, DB URL, Telegram server
- `api`: BotSafe, Monetag
- `logs`: Join logs, stats chat
- `queue`: Max queue size
- `retry`: URL/info/download retry counts
- `proxy`: Proxy file, rotation settings
- `performance`: Streaming threshold, max duration

---

### Utilities (`misc/`)

**Purpose:** Shared utilities for queue management and media processing

| File | Purpose | Tokens |
|------|---------|--------|
| video_types.py | Video/image sending, slideshow retry, HEIC conversion | 6,322 |
| queue_manager.py | Per-user concurrency limits | 1,029 |
| utils.py | Helpers (lang resolution, user registration) | 692 |

**Key Functions:**
- `send_video_result()`: Send video with thumbnail and music button
- `send_image_result()`: Send slideshow with Part 3 retry via `download_slideshow_images()`
- `send_music_result()`: Send audio with cover
- `QueueManager.info_queue()`: Acquire/release queue slot
- `get_error_message()`: Map exceptions to localized messages

**Image Conversion (HEIC ‚Üí JPEG):**
```python
def convert_image_to_jpeg_optimized(image_data: bytes) -> bytes:
    # quality=75, optimize=False, subsampling=2 (4:2:0), progressive=False
```

---

### Stats Module (`stats/`)

**Purpose:** Real-time statistics and graph generation

| File | Purpose | Tokens |
|------|---------|--------|
| router.py | Interactive stats menu commands | 3,413 |
| graphs.py | Matplotlib time series graphs | 1,347 |
| misc.py | Stats calculation, scheduled updates | 1,006 |
| loader.py | Stats bot initialization | 276 |
| botstat.py | BotSafe API integration | 365 |

**Features:**
- Quick stats (overall + daily)
- Time series graphs (users, videos, music)
- User search
- Referral tracking
- Scheduled message updates (hourly overall, 5-min daily)

---

## Data Flow

### Video Download Flow (with 3-Part Retry)

```mermaid
sequenceDiagram
    participant User
    participant Handler as get_video.py
    participant Queue as QueueManager
    participant Client as TikTokClient
    participant PS as ProxySession
    participant yt-dlp
    participant TikTok
    participant DB

    User->>Handler: Send TikTok URL
    Handler->>Handler: Validate URL regex
    Handler->>Queue: Check user queue size
    Queue-->>Handler: Under limit?
    Handler->>Queue: Acquire slot
    Handler->>User: Set reaction (üëÄ)
    Handler->>Client: video(url)

    Client->>PS: Create ProxySession
    PS-->>Client: Initial proxy

    rect rgb(200, 220, 255)
        Note over Client,TikTok: Part 1: URL Resolution
        Client->>TikTok: Resolve short URL
        alt Success
            TikTok-->>Client: Full URL
        else Failure
            Client->>PS: Rotate proxy
            Client->>TikTok: Retry resolve
        end
    end

    rect rgb(200, 255, 220)
        Note over Client,TikTok: Part 2: Video Info
        Client->>yt-dlp: Extract video info
        yt-dlp->>TikTok: Fetch page/API
        alt Success
            TikTok-->>yt-dlp: Video metadata
            yt-dlp-->>Client: VideoInfo
        else Transient Error
            Client->>PS: Rotate proxy
            Client->>yt-dlp: Retry extraction
        end
    end

    rect rgb(255, 220, 200)
        Note over Client,TikTok: Part 3: Download
        alt Video
            Client->>TikTok: Download video bytes
            TikTok-->>Client: Video data
            Client-->>Handler: VideoInfo (bytes)
            Handler->>User: Send video + music button
        else Slideshow
            Client-->>Handler: VideoInfo (image URLs + ProxySession)
            Handler->>TikTok: Download images (parallel with individual retry)
            Handler->>Handler: Convert HEIC if needed
            Handler->>User: Send image batches
        end
    end

    Handler->>DB: Log download
    Handler->>Queue: Release slot
    Handler->>User: Clear reaction
```

### Music Extraction Flow (with 2-Part Retry)

```mermaid
sequenceDiagram
    participant User
    participant Handler as get_music.py
    participant Client as TikTokClient
    participant PS as ProxySession
    participant TikTok
    participant DB

    User->>Handler: Click music button
    Handler->>Handler: Remove button (prevent double-click)
    Handler->>User: Set reaction (üëÄ)
    Handler->>Client: music(video_id)

    Client->>PS: Create ProxySession

    rect rgb(200, 255, 220)
        Note over Client,TikTok: Part 2: Music Info
        Client->>TikTok: Extract audio URL
        alt Failure
            Client->>PS: Rotate proxy
            Client->>TikTok: Retry extraction
        end
    end

    rect rgb(255, 220, 200)
        Note over Client,TikTok: Part 3: Download
        Client->>TikTok: Download audio + cover
        alt Failure
            Client->>PS: Rotate proxy
            Client->>TikTok: Retry download
        end
        TikTok-->>Client: MusicInfo
    end

    Client-->>Handler: MusicInfo
    Handler->>User: Send audio file
    Handler->>DB: Log music download
```

### Inline Mode Flow

```mermaid
sequenceDiagram
    participant User
    participant Inline as get_inline.py
    participant Client as TikTokClient
    participant Storage as Storage Channel

    User->>Inline: Inline query with URL
    Inline->>Inline: Validate user exists
    Inline-->>User: Return result with minimal loading indicator
    User->>Inline: Select result
    Inline->>Client: video(url) with bypass queue

    alt Video
        Client-->>Inline: VideoInfo
        Inline->>Storage: Upload video
        Storage-->>Inline: file_id
        Inline->>User: Edit inline message with video
    else Slideshow
        Inline->>User: Show "not supported" error
    end
```

## Conventions

### Code Style
- **Python 3.13** with strict version pinning
- **Async/await** throughout (aiogram, asyncpg, aiohttp)
- **Type hints** on function signatures
- **Dataclasses** for structured data (VideoInfo, MusicInfo, ProxySession)

### Error Handling
- Custom exception hierarchy (`TikTokError` base)
- 3-part retry with proxy rotation (instant retry)
- Permanent errors (deleted, private) not retried
- Emoji reactions for status updates (üëÄ ‚Üí üë®‚Äçüíª ‚Üí result)
- Localized error messages (private chats only, groups fail silently)

### Resource Management
- RAII pattern with context managers
- Singleton shared resources (executor, sessions)
- Explicit cleanup on shutdown
- ProxySession per request flow

### Configuration
- Environment variables via python-dotenv
- JSON arrays for lists (`ADMIN_IDS=[123,456]`)
- Sensible defaults in config.py

## Gotchas

### TikTok API
- **yt-dlp private API**: Uses `_extract_web_data_and_status()` which may break on updates
- **VideoInfo cleanup**: Slideshows MUST call `.close()` to release yt-dlp resources
- **Chrome 120 fixed**: Newer versions (136+) blocked with proxies due to fingerprint mismatch
- **TikTok status codes**: 10204=deleted, 10222=private, 10216=under review

### 3-Part Retry Strategy
- **ProxySession sticky**: Same proxy across all parts unless retry
- **Instant retry**: No delay on retry (proxy rotation = different IP)
- **Part 1 only for short URLs**: Full URLs skip Part 1
- **Permanent errors not retried**: Deleted, private, region errors fail immediately
- **Slideshow individual retry**: Failed images retry independently (not whole batch)

### Queue Management
- **Pre-check required**: Check queue size BEFORE acquiring slot
- **Inline bypass**: Inline downloads use `bypass_user_limit=True`

### Image Processing
- **Persistent ProcessPoolExecutor**: Avoids shutdown errors under high load (4 workers)
- **HEIF registration**: Opener registered once at module load
- **Group limit**: Only first 10 images sent in groups

### Database
- **Initialization order**: Must call `initialize_database_components()` before any DB ops
- **URL rewriting**: PostgreSQL URLs auto-converted to `postgresql+asyncpg://`

### Inline Mode
- **Storage channel required**: Must set `STORAGE_CHANNEL_ID`
- **No slideshows**: Inline mode only supports videos
- **Minimal loading indicator**: Button with "‚è≥" text and "loading" callback_data

## Navigation Guide

| Task | Files to Modify |
|------|----------------|
| Add new command | `handlers/*.py` ‚Üí Register in `main.py` |
| Modify TikTok extraction | `tiktok_api/client.py` |
| Change retry logic | `tiktok_api/client.py` (ProxySession, _*_with_retry methods) |
| Change browser impersonation | `tiktok_api/client.py` (TIKTOK_IMPERSONATE_TARGET, TIKTOK_USER_AGENT) |
| Change database schema | `data/models/*.py` (auto-creates tables) |
| Add language | Create `data/locale/XX.json` (auto-detected) |
| Tune performance | Set env vars or edit `data/config.py` defaults |
| Add error type | `tiktok_api/exceptions.py` ‚Üí Handle in `misc/video_types.py:get_error_message()` |
| Change queue limits | `MAX_USER_QUEUE_SIZE` env var |
| Add stats graph | `stats/router.py` + `stats/graphs.py` |
| Modify video sending | `misc/video_types.py:send_video_result()` |
| Modify slideshow sending | `misc/video_types.py:send_image_result()` |
| Add unsupported content handler | `handlers/get_video.py` |

## Environment Variables

### Required
| Variable | Description |
|----------|-------------|
| `BOT_TOKEN` | Main bot token |
| `DB_URL` | PostgreSQL connection string |
| `TG_SERVER` | Telegram API server URL |
| `TELEGRAM_API_ID` | Telegram API ID (for custom Bot API server) |
| `TELEGRAM_API_HASH` | Telegram API hash (for custom Bot API server) |

### Retry Configuration
| Variable | Default | Description |
|----------|---------|-------------|
| `URL_RESOLVE_MAX_RETRIES` | 3 | Part 1: URL resolution retries |
| `VIDEO_INFO_MAX_RETRIES` | 3 | Part 2: Video info extraction retries |
| `DOWNLOAD_MAX_RETRIES` | 3 | Part 3: Download retries |

### Performance
| Variable | Default | Description |
|----------|---------|-------------|
| `MAX_USER_QUEUE_SIZE` | 0 | Max concurrent per user (0=unlimited) |
| `MAX_VIDEO_DURATION` | 0 | Max video duration (seconds, 0=unlimited) |
| `STREAMING_DURATION_THRESHOLD` | 300 | Stream videos longer than this (seconds) |
| `LOG_LEVEL` | INFO | Logging level |

**Note:** Thread pool (500 workers) and curl_cffi connections (1000 per proxy) are hardcoded for maximum throughput.

See `.env.example` for complete list.

## Recent Changes (Since 2025-01-15)

1. **Chrome 120 Impersonation** - Fixed to Chrome 120 to bypass TikTok WAF blocking
2. **Unsupported Content Handlers** - New handlers for videos, images, voice messages in private chats
3. **Minimal Loading Indicator** - Inline queries show "‚è≥" button instead of "Please wait" text
4. **Performance Hardcoding** - Removed performance config, hardcoded maximum throughput values
5. **Proxy Rotation Fixes** - Improved proxy handling for TikTok extraction
