---
last_mapped: 2026-01-14T00:00:00Z
total_files: 58
total_tokens: 63095
---

# Codebase Map

> Auto-generated by Cartographer. Last mapped: 2026-01-14

## System Overview

**tt-bot** is a production-grade Telegram bot for downloading TikTok videos, slideshows, and audio without watermarks. Built with Python 3.13, aiogram 3.x, and yt-dlp.

**Version:** 4.5.0
**Stack:** Python 3.13, aiogram 3.24, yt-dlp, curl_cffi, SQLAlchemy 2.0, asyncpg, aiohttp

```mermaid
graph TB
    subgraph Entry["Entry Points"]
        Main[main.py<br/>Main Bot]
        Stats[stats.py<br/>Stats Bot]
        Maint[maintenance_bot.py<br/>Maintenance Mode]
    end

    subgraph Handlers["Telegram Handlers"]
        Video[get_video.py<br/>Video Downloads]
        Music[get_music.py<br/>Audio Extraction]
        Inline[get_inline.py<br/>Inline Mode]
        User[user.py<br/>User Commands]
        Admin[admin.py<br/>Admin Commands]
        Lang[lang.py<br/>Language Selection]
        Advert[advert.py<br/>Broadcasts]
    end

    subgraph TikTok["TikTok API"]
        Client[client.py<br/>Main Client]
        Proxy[proxy_manager.py<br/>Proxy Rotation]
        Models[models.py<br/>VideoInfo/MusicInfo]
        Exc[exceptions.py<br/>Error Types]
    end

    subgraph Data["Data Layer"]
        Config[config.py<br/>Configuration]
        DB[database.py<br/>SQLAlchemy Engine]
        DBSvc[db_service.py<br/>Repository]
        DBModels[models/<br/>User/Video/Music]
    end

    subgraph Misc["Utilities"]
        Queue[queue_manager.py<br/>Concurrency Control]
        VTypes[video_types.py<br/>Send/Process Media]
        Utils[utils.py<br/>Helpers]
    end

    subgraph StatsM["Stats Module"]
        Router[router.py<br/>Stats Commands]
        Graphs[graphs.py<br/>Graph Generation]
        StMisc[misc.py<br/>Stats Calculation]
    end

    Main --> Handlers
    Stats --> StatsM
    Handlers --> TikTok
    Handlers --> Misc
    TikTok --> Proxy
    Handlers --> Data
    StatsM --> Data
    VTypes --> Client
```

## Directory Structure

```
tt-bot/
‚îú‚îÄ‚îÄ main.py                 # Main bot entry point
‚îú‚îÄ‚îÄ stats.py                # Stats bot entry point
‚îú‚îÄ‚îÄ maintenance_bot.py      # Maintenance mode bot
‚îú‚îÄ‚îÄ tiktok_api/             # TikTok extraction module
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py         # Public exports
‚îÇ   ‚îú‚îÄ‚îÄ client.py           # Main TikTokClient (yt-dlp + curl_cffi)
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py       # Exception hierarchy
‚îÇ   ‚îú‚îÄ‚îÄ models.py           # VideoInfo, MusicInfo dataclasses
‚îÇ   ‚îî‚îÄ‚îÄ proxy_manager.py    # Round-robin proxy rotation
‚îú‚îÄ‚îÄ handlers/               # Telegram message handlers
‚îÇ   ‚îú‚îÄ‚îÄ get_video.py        # Video/slideshow download handler
‚îÇ   ‚îú‚îÄ‚îÄ get_music.py        # Audio extraction handler
‚îÇ   ‚îú‚îÄ‚îÄ get_inline.py       # Inline mode handler
‚îÇ   ‚îú‚îÄ‚îÄ user.py             # /start, /mode commands
‚îÇ   ‚îú‚îÄ‚îÄ admin.py            # Admin commands
‚îÇ   ‚îú‚îÄ‚îÄ advert.py           # Broadcast system
‚îÇ   ‚îî‚îÄ‚îÄ lang.py             # Language selection
‚îú‚îÄ‚îÄ data/                   # Data layer
‚îÇ   ‚îú‚îÄ‚îÄ config.py           # Configuration loading
‚îÇ   ‚îú‚îÄ‚îÄ loader.py           # Bot/dispatcher initialization
‚îÇ   ‚îú‚îÄ‚îÄ database.py         # SQLAlchemy engine/session
‚îÇ   ‚îú‚îÄ‚îÄ db_service.py       # Database operations
‚îÇ   ‚îú‚îÄ‚îÄ db_utils.py         # URL utilities
‚îÇ   ‚îú‚îÄ‚îÄ locale/             # Language translations (8 languages)
‚îÇ   ‚îî‚îÄ‚îÄ models/             # SQLAlchemy models
‚îÇ       ‚îú‚îÄ‚îÄ users.py        # Users table
‚îÇ       ‚îú‚îÄ‚îÄ video.py        # Videos table
‚îÇ       ‚îî‚îÄ‚îÄ music.py        # Music table
‚îú‚îÄ‚îÄ misc/                   # Utilities
‚îÇ   ‚îú‚îÄ‚îÄ queue_manager.py    # Per-user concurrency control
‚îÇ   ‚îú‚îÄ‚îÄ video_types.py      # Media sending/processing
‚îÇ   ‚îî‚îÄ‚îÄ utils.py            # Helper functions
‚îú‚îÄ‚îÄ stats/                  # Statistics module
‚îÇ   ‚îú‚îÄ‚îÄ loader.py           # Stats bot initialization
‚îÇ   ‚îú‚îÄ‚îÄ router.py           # Stats commands
‚îÇ   ‚îú‚îÄ‚îÄ graphs.py           # Matplotlib graphs
‚îÇ   ‚îú‚îÄ‚îÄ misc.py             # Stats calculation
‚îÇ   ‚îî‚îÄ‚îÄ botstat.py          # BotSafe integration
‚îú‚îÄ‚îÄ docs/                   # Documentation
‚îú‚îÄ‚îÄ scripts/                # Shell scripts
‚îú‚îÄ‚îÄ Dockerfile              # Container build
‚îú‚îÄ‚îÄ docker-compose.yml      # Service orchestration
‚îî‚îÄ‚îÄ pyproject.toml          # Dependencies (uv)
```

## Module Guide

### TikTok API (`tiktok_api/`)

**Purpose:** TikTok video/audio extraction using yt-dlp with browser impersonation

| File | Purpose | Tokens |
|------|---------|--------|
| client.py | Main TikTokClient with retry logic, proxy support | 14,918 |
| proxy_manager.py | Thread-safe round-robin proxy rotation | 1,303 |
| models.py | VideoInfo, MusicInfo dataclasses | 1,014 |
| exceptions.py | Exception hierarchy (8 error types) | 203 |

**Key Exports:**
- `TikTokClient`: Main extraction client
- `ProxyManager`: Proxy rotation manager
- `VideoInfo`, `MusicInfo`: Response dataclasses
- Exception classes: `TikTokError`, `TikTokDeletedError`, `TikTokPrivateError`, etc.

**Patterns:**
- Singleton resources (ThreadPoolExecutor, curl session, aiohttp connector)
- Context manager for VideoInfo cleanup (RAII)
- Strategy pattern for proxy management

---

### Handlers (`handlers/`)

**Purpose:** Telegram message/callback handlers using aiogram routers

| File | Purpose | Tokens |
|------|---------|--------|
| get_video.py | Video/slideshow download with queue management | 2,305 |
| get_inline.py | Inline query handling | 1,555 |
| get_music.py | Audio extraction from callback | 1,177 |
| advert.py | Admin broadcast system | 852 |
| lang.py | Language selection | 469 |
| user.py | /start, /mode commands | 384 |
| admin.py | Admin commands (/msg, /export, /botstat) | 348 |

**Key Routes:**
- `video_router`: Handles TikTok URLs in messages
- `music_router`: Handles music button callbacks
- `inline_router`: Handles inline queries and chosen results
- `user_router`: /start, /mode
- `lang_router`: /lang and language callbacks
- `admin_router`: Admin-only commands
- `advert_router`: Broadcast management

---

### Data Layer (`data/`)

**Purpose:** Configuration, database, and localization

| File | Purpose | Tokens |
|------|---------|--------|
| config.py | Load config from env vars, load locales | 1,615 |
| db_service.py | Repository pattern database operations | 1,609 |
| database.py | SQLAlchemy async engine/session | 517 |
| loader.py | Bot/dispatcher/scheduler initialization | 293 |
| db_utils.py | Database URL utilities | 379 |

**Models:**
- `Users`: user_id, lang, file_mode, ad tracking
- `Video`: download history with timestamps
- `Music`: music download history

**Configuration Sections:**
- `bot`: Tokens, DB URL, Telegram server
- `api`: BotSafe, Monetag
- `logs`: Join logs, stats chat
- `queue`: Limits, retry settings
- `proxy`: Proxy file, rotation settings
- `performance`: Pool sizes, timeouts

---

### Utilities (`misc/`)

**Purpose:** Shared utilities for queue management and media processing

| File | Purpose | Tokens |
|------|---------|--------|
| video_types.py | Video/image sending, HEIC conversion | 5,990 |
| queue_manager.py | Per-user concurrency limits | 1,021 |
| utils.py | Helpers (lang resolution, user registration) | 692 |

**Key Functions:**
- `send_video_result()`: Send video with thumbnail and music button
- `send_image_result()`: Send slideshow images with HEIC conversion
- `send_music_result()`: Send audio with cover
- `QueueManager.info_queue()`: Acquire/release queue slot

---

### Stats Module (`stats/`)

**Purpose:** Real-time statistics and graph generation

| File | Purpose | Tokens |
|------|---------|--------|
| router.py | Interactive stats menu commands | 3,413 |
| graphs.py | Matplotlib time series graphs | 1,347 |
| misc.py | Stats calculation, scheduled updates | 1,006 |
| loader.py | Stats bot initialization | 276 |
| botstat.py | BotSafe API integration | 365 |

**Features:**
- Quick stats (overall + daily)
- Time series graphs (users, videos, music)
- User search
- Referral tracking
- Scheduled message updates (hourly overall, 5-min daily)

---

## Data Flow

### Video Download Flow

```mermaid
sequenceDiagram
    participant User
    participant Handler as get_video.py
    participant Queue as QueueManager
    participant Client as TikTokClient
    participant yt-dlp
    participant TikTok
    participant DB

    User->>Handler: Send TikTok URL
    Handler->>Handler: Validate URL regex
    Handler->>Queue: Check user queue size
    Queue-->>Handler: Under limit?
    Handler->>Queue: Acquire slot
    Handler->>User: Set reaction (üëÄ)
    Handler->>Client: video_with_retry()
    Client->>yt-dlp: Extract video info
    yt-dlp->>TikTok: Fetch page/API
    TikTok-->>yt-dlp: Video metadata
    yt-dlp-->>Client: VideoInfo

    alt Video
        Client->>TikTok: Download video bytes
        TikTok-->>Client: Video data
        Client-->>Handler: VideoInfo (bytes)
        Handler->>User: Send video + music button
    else Slideshow
        Client-->>Handler: VideoInfo (image URLs)
        Handler->>TikTok: Download images (parallel)
        Handler->>Handler: Convert HEIC if needed
        Handler->>User: Send image batches
    end

    Handler->>DB: Log download
    Handler->>Queue: Release slot
    Handler->>User: Clear reaction
```

### Music Extraction Flow

```mermaid
sequenceDiagram
    participant User
    participant Handler as get_music.py
    participant Client as TikTokClient
    participant TikTok
    participant DB

    User->>Handler: Click music button
    Handler->>Handler: Remove button (prevent double-click)
    Handler->>User: Set reaction (üëÄ)
    Handler->>Client: music_with_retry(video_id)
    Client->>TikTok: Extract audio URL
    Client->>TikTok: Download audio + cover
    TikTok-->>Client: MusicInfo
    Client-->>Handler: MusicInfo
    Handler->>User: Send audio file
    Handler->>DB: Log music download
```

### Inline Mode Flow

```mermaid
sequenceDiagram
    participant User
    participant Inline as get_inline.py
    participant Client as TikTokClient
    participant Storage as Storage Channel

    User->>Inline: Inline query with URL
    Inline->>Inline: Validate user exists
    Inline-->>User: Return article result
    User->>Inline: Select result
    Inline->>Client: video_with_retry (bypass queue)

    alt Video
        Client-->>Inline: VideoInfo
        Inline->>Storage: Upload video
        Storage-->>Inline: file_id
        Inline->>User: Edit inline message with video
    else Slideshow
        Inline->>User: Show "not supported" error
    end
```

## Conventions

### Code Style
- **Python 3.13** with strict version pinning
- **Async/await** throughout (aiogram, asyncpg, aiohttp)
- **Type hints** on function signatures
- **Dataclasses** for structured data (VideoInfo, MusicInfo)

### Error Handling
- Custom exception hierarchy (`TikTokError` base)
- Retry logic with exponential backoff
- Emoji reactions for status updates (üëÄ ‚Üí ü§î ‚Üí üôè ‚Üí üò¢)
- Localized error messages

### Resource Management
- RAII pattern with context managers
- Singleton shared resources (executor, sessions)
- Explicit cleanup on shutdown

### Configuration
- Environment variables via python-dotenv
- JSON arrays for lists (`ADMIN_IDS=[123,456]`)
- Sensible defaults in config.py

## Gotchas

### TikTok API
- **yt-dlp private API**: Uses `_extract_web_data_and_status()` which may break on updates
- **VideoInfo cleanup**: Slideshows MUST call `.close()` to release yt-dlp resources
- **Browser impersonation**: Auto-updates from yt-dlp BROWSER_TARGETS
- **Executor initialization**: Must call `TikTokClient.set_executor_size()` before first use

### Queue Management
- **Pre-check required**: Check queue size BEFORE acquiring slot
- **Inline bypass**: Inline downloads use `bypass_user_limit=True`

### Image Processing
- **Persistent ProcessPoolExecutor**: Avoids shutdown errors under high load
- **HEIF registration**: Opener registered once at module load
- **Group limit**: Only first 10 images sent in groups

### Database
- **Initialization order**: Must call `initialize_database_components()` before any DB ops
- **URL rewriting**: PostgreSQL URLs auto-converted to `postgresql+asyncpg://`

### Inline Mode
- **Storage channel required**: Must set `STORAGE_CHANNEL_ID`
- **No slideshows**: Inline mode only supports videos

## Navigation Guide

| Task | Files to Modify |
|------|----------------|
| Add new command | `handlers/*.py` ‚Üí Register in `main.py` |
| Modify TikTok extraction | `tiktok_api/client.py` |
| Change database schema | `data/models/*.py` (auto-creates tables) |
| Add language | Create `data/locale/XX.json` (auto-detected) |
| Tune performance | Set env vars or edit `data/config.py` defaults |
| Add error type | `tiktok_api/exceptions.py` ‚Üí Handle in `handlers/get_video.py` |
| Change queue limits | `MAX_USER_QUEUE_SIZE` env var |
| Add stats graph | `stats/router.py` + `stats/graphs.py` |
| Modify video sending | `misc/video_types.py:send_video_result()` |

## Environment Variables

### Required
| Variable | Description |
|----------|-------------|
| `BOT_TOKEN` | Main bot token |
| `DB_URL` | PostgreSQL connection string |
| `TG_SERVER` | Telegram API server URL |

### Optional (with defaults)
| Variable | Default | Description |
|----------|---------|-------------|
| `THREAD_POOL_SIZE` | 128 | ThreadPoolExecutor workers |
| `MAX_USER_QUEUE_SIZE` | 3 | Max concurrent per user |
| `RETRY_MAX_ATTEMPTS` | 3 | Retry attempts |
| `RETRY_REQUEST_TIMEOUT` | 10 | Timeout per request (seconds) |
| `MAX_VIDEO_DURATION` | 1800 | Max video duration (seconds, 0=unlimited) |
| `LOG_LEVEL` | INFO | Logging level |

See `.env.example` for complete list.
